<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Informe de Socios · {{ empresa.nombre }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @media print {
      .no-print {
        display: none !important;
      }
      body {
        font-size: 12px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 4px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <main class="max-w-7xl mx-auto py-8 px-4 space-y-8">

    <!-- Encabezado -->
    <header class="bg-white rounded-xl shadow-sm p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-users text-blue-500 mr-2"></i>
            Informe de Socios (Clientes)
          </h1>
          <div class="flex flex-wrap items-center mt-2 gap-3">
            <span class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full">
              <i class="fas fa-building mr-1"></i>{{ empresa.nombre }}
            </span>
            <span class="text-sm text-gray-600">
              <i class="far fa-calendar-alt mr-1"></i>{{ fecha_generacion|date:"d/m/Y H:i" }}
            </span>
            {% if error %}
            <span class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded-full">
              <i class="fas fa-exclamation-triangle mr-1"></i>Error: {{ error }}
            </span>
            {% endif %}
          </div>
        </div>
        <div class="flex space-x-3 no-print">
          <a href="{% url 'panel_empresa' slug=slug %}" 
             class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> Volver al Panel
          </a>
          <button onclick="window.print()" 
                  class="px-4 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium flex items-center transition-colors">
            <i class="fas fa-print mr-2"></i> Imprimir
          </button>
        </div>
      </div>
    </header>

    <!-- Resumen Estadístico -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
        <p class="text-sm text-gray-500">Total Socios</p>
        <p class="text-2xl font-bold text-gray-800">{{ estadisticas.total_socios }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
        <p class="text-sm text-gray-500">Con Email</p>
        <p class="text-2xl font-bold text-gray-800">{{ estadisticas.socios_con_email }}</p>
        <p class="text-xs text-gray-500 mt-1">{{ estadisticas.porcentaje_con_email|floatformat:1 }}%</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500">
        <p class="text-sm text-gray-500">Con Teléfono</p>
        <p class="text-2xl font-bold text-gray-800">{{ estadisticas.socios_con_telefono }}</p>
        <p class="text-xs text-gray-500 mt-1">{{ estadisticas.porcentaje_con_telefono|floatformat:1 }}%</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-amber-500">
        <p class="text-sm text-gray-500">Con Coordenadas</p>
        <p class="text-2xl font-bold text-gray-800">{{ estadisticas.socios_con_coordenadas }}</p>
      </div>
    </div>

    <!-- Filtros -->
    <section class="bg-white rounded-xl shadow-sm p-6 no-print">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-filter mr-2 text-blue-500"></i> Filtros
      </h2>
      <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-map-marker-alt mr-1"></i> Sector
          </label>
          <select name="sector" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Todos los sectores</option>
            {% for sector in sectores %}
              <option value="{{ sector }}" {% if filtros.sector == sector %}selected{% endif %}>{{ sector }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-search mr-1"></i> Búsqueda
          </label>
          <input type="text" name="busqueda" value="{{ filtros.busqueda }}" 
                 placeholder="Nombre, RUT, dirección..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="md:col-span-2 flex space-x-3">
          <button type="submit" 
                  class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium flex items-center justify-center transition-colors">
            <i class="fas fa-search mr-2"></i> Buscar
          </button>
          <a href="{% url 'informe_socios' alias=slug %}" 
             class="px-4 py-2.5 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 flex items-center transition-colors">
            <i class="fas fa-redo mr-2"></i> Limpiar
          </a>
        </div>
      </form>
    </section>

    <!-- Distribución por Sector -->
    <section class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-chart-pie mr-2 text-blue-500"></i> Distribución por Sector
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for item in estadisticas.socios_por_sector %}
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium text-gray-700">
              {{ item.sector|default:"Sin sector" }}
            </span>
            <span class="text-lg font-bold text-blue-700">{{ item.cantidad }}</span>
          </div>
          <div class="mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" 
                   style="width: {% widthratio item.cantidad estadisticas.total_socios 100 %}%">
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-span-4 text-center py-8">
          <p class="text-gray-500">No hay datos de sectores</p>
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- Tabla de Socios -->
    <section class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="px-6 py-4 border-b bg-gray-50">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <h2 class="text-lg font-semibold text-gray-800 flex items-center">
            <i class="fas fa-list mr-2 text-blue-500"></i> Detalle de Socios
          </h2>
          <div class="text-sm text-gray-500">
            <span class="bg-gray-200 px-3 py-1 rounded-full">
              {{ socios|length }} socio{{ socios|length|pluralize }}
            </span>
          </div>
        </div>
      </div>
      
      {% if socios %}
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <i class="fas fa-user mr-1"></i> Socio
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <i class="fas fa-id-card mr-1"></i> RUT / Contacto
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <i class="fas fa-map-marker-alt mr-1"></i> Dirección / Sector
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <i class="fas fa-info-circle mr-1"></i> Información
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for socio in socios %}
              <tr class="hover:bg-gray-50 transition-colors">
                <!-- Columna Socio -->
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                      <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-900">
                        {{ socio.nombre }}
                      </p>
                      <p class="text-xs text-gray-500">
                        <i class="fas fa-tachometer-alt mr-1"></i>{{ socio.medidor }}
                      </p>
                    </div>
                  </div>
                </td>
                
                <!-- Columna RUT / Contacto -->
                <td class="px-6 py-4">
                  <div class="space-y-2">
                    <div>
                      <p class="text-sm font-medium text-gray-900">{{ socio.rut }}</p>
                    </div>
                    <div class="flex flex-wrap gap-1">
                      {% if socio.tiene_telefono %}
                      <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-green-100 text-green-700">
                        <i class="fas fa-phone mr-1"></i>{{ socio.telefono }}
                      </span>
                      {% endif %}
                      
                      {% if socio.tiene_email %}
                      <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                        <i class="fas fa-envelope mr-1"></i>Email
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </td>
                
                <!-- Columna Dirección / Sector -->
                <td class="px-6 py-4">
                  <div class="space-y-2">
                    <div>
                      <p class="text-sm text-gray-900">{{ socio.direccion }}</p>
                    </div>
                    {% if socio.sector %}
                    <div>
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                        <i class="fas fa-map-marker-alt mr-1"></i>{{ socio.sector }}
                      </span>
                    </div>
                    {% endif %}
                    {% if socio.tiene_coordenadas %}
                    <div class="text-xs text-gray-500">
                      <i class="fas fa-crosshairs mr-1"></i>Con coordenadas
                    </div>
                    {% endif %}
                  </div>
                </td>
                
                <!-- Columna Información -->
                <td class="px-6 py-4">
                  <div class="space-y-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <i class="fas fa-check-circle mr-1"></i>
                      Activo
                    </span>
                    
                    <div class="flex flex-wrap gap-1">
                      {% if not socio.tiene_email %}
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-red-100 text-red-700">
                        <i class="fas fa-exclamation-circle mr-1"></i>Sin email
                      </span>
                      {% endif %}
                      
                      {% if not socio.tiene_telefono %}
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-red-100 text-red-700">
                        <i class="fas fa-exclamation-circle mr-1"></i>Sin teléfono
                      </span>
                      {% endif %}
                      
                      {% if not socio.tiene_coordenadas %}
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-yellow-100 text-yellow-700">
                        <i class="fas fa-map-pin mr-1"></i>Sin ubicación
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="bg-gray-50 font-semibold">
              <tr>
                <td colspan="4" class="px-6 py-4">
                  <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-700">
                      Total: {{ socios|length }} socio{{ socios|length|pluralize }}
                    </div>
                    <div class="flex space-x-4 text-sm">
                      <span class="text-green-600">
                        <i class="fas fa-envelope mr-1"></i>{{ estadisticas.socios_con_email }} con email
                      </span>
                      <span class="text-blue-600">
                        <i class="fas fa-phone mr-1"></i>{{ estadisticas.socios_con_telefono }} con teléfono
                      </span>
                      <span class="text-purple-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>{{ estadisticas.socios_con_coordenadas }} con ubicación
                      </span>
                    </div>
                  </div>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      {% else %}
        <div class="text-center py-12">
          <div class="mx-auto w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
            <i class="fas fa-users text-gray-400 text-2xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-700 mb-2">
            {% if filtros.sector or filtros.busqueda %}
              No se encontraron socios con los filtros aplicados
            {% else %}
              No hay socios registrados en esta empresa
            {% endif %}
          </h3>
          <p class="text-gray-500 mb-6">
            {% if filtros.sector or filtros.busqueda %}
              Intenta con otros filtros o <a href="{% url 'informe_socios' alias=slug %}" class="text-blue-600 hover:underline">muestra todos los socios</a>.
            {% else %}
              Comienza registrando socios en el sistema.
            {% endif %}
          </p>
        </div>
      {% endif %}
    </section>

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Funcionalidad para mostrar/ocultar detalles
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach(row => {
        row.addEventListener('click', function(e) {
          if (!e.target.closest('a') && !e.target.closest('button')) {
            this.classList.toggle('bg-blue-50');
          }
        });
      });
      
      // Búsqueda en tiempo real (opcional)
      const searchInput = document.querySelector('input[name="busqueda"]');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            if (this.value.length >= 3 || this.value.length === 0) {
              this.form.submit();
            }
          }, 500);
        });
      }
    });
  </script>
</body>
</html>